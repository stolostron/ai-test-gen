<!DOCTYPE html>
<html>
<head>
    <title>Test Case: ACM ClusterCurator Unit Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .test-id { color: #0066cc; font-weight: bold; }
        .priority-high { color: #cc0000; font-weight: bold; }
        .step-number { background-color: #e6f3ff; font-weight: bold; padding: 4px 8px; }
    </style>
</head>
<body>
    <h1 class="test-id">Test Case ID: ACM-CLC-001</h1>
    
    <table>
        <tr><th>Field</th><th>Value</th></tr>
        <tr><td>Test Title</td><td>Verify validateUpgradeVersion function with digest discovery</td></tr>
        <tr><td>Priority</td><td class="priority-high">High</td></tr>
        <tr><td>Component</td><td>ClusterCurator - Upgrade Module</td></tr>
        <tr><td>Test Type</td><td>Unit Test</td></tr>
        <tr><td>Estimated Duration</td><td>15 minutes</td></tr>
        <tr><td>Author</td><td>ACM QE Team</td></tr>
        <tr><td>Related JIRA</td><td>ACM-22079</td></tr>
    </table>

    <h2>ðŸŽ¯ Test Objective</h2>
    <p>Validate that the <code>validateUpgradeVersion</code> function correctly discovers image digests from conditionalUpdates and availableUpdates arrays when force upgrade annotation is present.</p>

    <h2>ðŸ“‹ Prerequisites</h2>
    <ul>
        <li>âœ… Go testing framework set up</li>
        <li>âœ… ClusterCurator test environment configured</li>
        <li>âœ… Mock ClusterVersion objects available</li>
        <li>âœ… Test client with proper permissions</li>
        <li>âœ… Force upgrade annotation enabled: <code>cluster.open-cluster-management.io/upgrade-allow-not-recommended-versions: "true"</code></li>
    </ul>

    <h2>ðŸ§ª Test Data</h2>
    <table>
        <tr><th>Parameter</th><th>Value</th><th>Purpose</th></tr>
        <tr><td>Desired Update</td><td>4.5.10</td><td>Target OpenShift version</td></tr>
        <tr><td>Source Digest</td><td>sha256:71e158c6173ad6aa6e356c119a87459196bbe70e89c0db1e35c1f63a87d90676</td><td>Expected digest in conditionalUpdates</td></tr>
        <tr><td>Fallback Digest</td><td>sha256:abcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890</td><td>Digest in availableUpdates</td></tr>
        <tr><td>Cluster Name</td><td>test-managed-cluster</td><td>Target cluster for upgrade</td></tr>
    </table>

    <h2>ðŸ”¬ Test Steps</h2>
    <ol>
        <li><span class="step-number">SETUP</span> Create mock ClusterCurator with force upgrade annotation</li>
        <li><span class="step-number">SETUP</span> Configure test client with proper RBAC permissions</li>
        <li><span class="step-number">ACTION</span> Call <code>validateUpgradeVersion(client, "test-managed-cluster", curator)</code></li>
        <li><span class="step-number">VERIFY</span> Function returns expected digest string without error</li>
        <li><span class="step-number">VERIFY</span> Digest matches expected SHA256 value from conditionalUpdates</li>
        <li><span class="step-number">VERIFY</span> Log entries show "Found conditional update image digest"</li>
        <li><span class="step-number">CLEANUP</span> Clean up test resources and mocks</li>
    </ol>

    <h2>âœ… Expected Results</h2>
    <table>
        <tr><th>Verification Point</th><th>Expected Result</th><th>Status</th></tr>
        <tr><td>Function Return</td><td>Returns (digest_string, nil)</td><td>ðŸ”³ Pending</td></tr>
        <tr><td>Digest Value</td><td>sha256:71e158c6173ad6aa6e356c119a87459196bbe70e89c0db1e35c1f63a87d90676</td><td>ðŸ”³ Pending</td></tr>
        <tr><td>Error Handling</td><td>No errors returned</td><td>ðŸ”³ Pending</td></tr>
        <tr><td>Logging</td><td>Appropriate debug messages logged</td><td>ðŸ”³ Pending</td></tr>
        <tr><td>Performance</td><td>Function completes within 5 seconds</td><td>ðŸ”³ Pending</td></tr>
    </table>

    <h2>ðŸš¨ Error Scenarios</h2>
    <ul>
        <li><strong>No Digest Found</strong>: Function should return empty string, no error</li>
        <li><strong>Missing Annotation</strong>: Should skip digest discovery, return empty string</li>
        <li><strong>Invalid ClusterVersion</strong>: Should handle gracefully, return appropriate error</li>
        <li><strong>Network Timeout</strong>: Should respect timeout settings, return timeout error</li>
    </ul>

    <h2>ðŸ”§ Implementation Notes</h2>
    <ul>
        <li>Test uses existing Go test patterns from ACM test suite</li>
        <li>Mocks should simulate realistic ClusterVersion responses</li>
        <li>Focus on digest discovery algorithm correctness</li>
        <li>Validate both conditionalUpdates and availableUpdates scenarios</li>
    </ul>

    <h2>ðŸ“Š Traceability</h2>
    <table>
        <tr><th>Requirement</th><th>Test Coverage</th></tr>
        <tr><td>ACM-22079: Digest Discovery</td><td>Direct validation of digest extraction</td></tr>
        <tr><td>Force Annotation Behavior</td><td>Validates annotation-gated functionality</td></tr>
        <tr><td>Error Handling</td><td>Multiple error scenario validations</td></tr>
        <tr><td>Performance</td><td>Execution time validation</td></tr>
    </table>

    <hr>
    <p><small>
        <strong>Test Case Version:</strong> 1.0 | 
        <strong>Last Updated:</strong> January 2025 | 
        <strong>Next Review:</strong> Quarterly
    </small></p>
</body>
</html>